<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Online Game</title>
    <meta charset="UTF-8"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">

    <!-- SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let gameId = 0;
        let currentNick = "";

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);

                // Подписываемся
                stompClient.subscribe('/topic/online-game-' + gameId, function(message) {
                    if (!message.body) {
                        return;
                    }

                    if (message.body === '"CLOSED"') {
                        showSessionClosedModal(); // показываем модалку
                        return;
                    }

                    const onlineGame = JSON.parse(message.body);
                    updateBoard(onlineGame.game);
                    updateStatus(onlineGame);
                });

                // <--- ADD: сразу после connect() запросим актуальное состояние
                fetch('/online-state?gameId=' + gameId)
                    .then(resp => resp.json())
                    .then(og => {
                        updateBoard(og.game);
                        updateStatus(og);
                    })
                    .catch(e => console.error('Cannot fetch online-state', e));
                // <--- /ADD
            });
        }

        function sendMove(row, col) {
            // index is 0..8
            const msg = {
                gameId: gameId,
                nick: currentNick,
                row: row,
                col: col
            };
            stompClient.send("/app/online-move", {}, JSON.stringify(msg));
        }

        function updateBoard(game) {
            const board = game.board; // array of 9
            for (let i = 0; i < 9; i++) {
                const cell = document.getElementById('cell' + i);
                const val = board[i];
                if (val === 'CROSS') {
                    cell.innerText = 'X';
                } else if (val === 'NOUGHT') {
                    cell.innerText = 'O';
                } else {
                    cell.innerText = '';
                }
            }
        }

        // ADD: rematch
        function rematch() {
            // const msg = { gameId: gameId, nick: currentNick }; todo old, with nick
            const msg = { gameId: gameId };
            stompClient.send("/app/rematch", {}, JSON.stringify(msg));
        }

        function updateStatus(onlineGame) {
            const game = onlineGame.game;
            const statusEl = document.getElementById('status');

            // ADD: score
            document.getElementById('scoreX').innerText = onlineGame.scoreX;
            document.getElementById('scoreO').innerText = onlineGame.scoreO;

            if (onlineGame.finished) {
                // игра закончилась
                if (game.winner === 'DRAW') {
                    statusEl.innerText = 'Ничья!';
                } else if (game.winner === 'X') {
                    statusEl.innerText = 'Победил: ' + (onlineGame.playerX ?? 'X');
                } else if (game.winner === 'O') {
                    statusEl.innerText = 'Победил: ' + (onlineGame.playerO ?? 'O');
                }
                // показать кнопку "Rematch!"
                document.getElementById('rematchBtn').style.display = 'inline-block';
            } else {
                // игра не закончена
                document.getElementById('rematchBtn').style.display='none';
                statusEl.innerText = 'Ход: ' + game.currentPlayer; // "X" or "O"
            }

            document.getElementById('playerX').innerText = onlineGame.playerX ?? '---';
            document.getElementById('playerO').innerText = onlineGame.playerO ?? '---';
        }

        window.addEventListener('load', () => {
            // parse gameId from URL (e.g. ?gameId=123)
            const params = new URLSearchParams(window.location.search);
            gameId = params.get('gameId');
            document.getElementById('gid').innerText = gameId;

            // get nick from thymeleaf or session
            currentNick = document.getElementById('nick').innerText;

            connect();
        });

        function leaveCurrentGame() {
            const msg = { gameId: gameId, nick: currentNick };
            stompClient.send("/app/leave-game", {}, JSON.stringify(msg));
            // возможно, закрываем вкладку, или
            window.location.href = "/online";
        }

        function askBeforeLeave() {
            if (confirm("Вы уверены, что хотите выйти?")) {
                leaveCurrentGame();
            }
        }

        // modal windows for second player
        function showSessionClosedModal() {
            const m = document.getElementById('sessionClosedModal');
            m.style.display='block';
            // запуск таймера 5s
            let sec = 5;
            const timerSpan = document.getElementById('closeTimer');
            const interval = setInterval(()=>{
                sec--;
                timerSpan.innerText=sec;
                if(sec<=0) {
                    clearInterval(interval);
                    window.location.href="/online";
                }
            }, 1000);
        }
        function goToList() {
            window.location.href="/online";
        }

        // для модальных окон выхода
        function showCreatorLeaveModal() {
            document.getElementById('creatorLeaveModal').style.display = 'block';
        }
        function confirmCreatorLeave() {
            // нажали «Выйти» => вызываем leaveCurrentGame()
            document.getElementById('creatorLeaveModal').style.display='none';
            leaveCurrentGame();
        }

        function cancelCreatorLeave() {
            // нажали «Отменить» => закрываем окно
            document.getElementById('creatorLeaveModal').style.display='none';
        }

    </script>
</head>
<body>
<div class="container">
    <section class="section">
        <h1 class="title">Онлайн-игра #<span id="gid"></span></h1>
        <p>Ваш ник: <span id="nick" th:text="${nick}">Guest</span></p>

        <p>Игрок X: <span id="playerX" th:text="${onlineGame.playerX}">X</span>(<span id="scoreX">0</span>)</p>
        <p>Игрок O: <span id="playerO" th:text="${onlineGame.playerO}">O</span>(<span id="scoreO">0</span>)</p>

<!--        < -->

        <p id="status" style="font-weight: bold;">...</p>

        <div style="margin-top: 20px;">
            <div style="display: flex;">
                <div id="cell0" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(0,0)"></div>
                <div id="cell1" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(0,1)"></div>
                <div id="cell2" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(0,2)"></div>
            </div>
            <div style="display: flex;">
                <div id="cell3" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(1,0)"></div>
                <div id="cell4" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(1,1)"></div>
                <div id="cell5" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(1,2)"></div>
            </div>
            <div style="display: flex;">
                <div id="cell6" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(2,0)"></div>
                <div id="cell7" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(2,1)"></div>
                <div id="cell8" class="box" style="width:60px;height:60px;margin:2px;text-align:center;font-size:24px;cursor:pointer;"
                     onclick="sendMove(2,2)"></div>
            </div>
        </div>
        <br/>
        <button id="rematchBtn" class="button is-warning" style="display:none;" onclick="rematch()">Реванш</button>
        <br/>
        <br/>
        <button class="button" onclick="showCreatorLeaveModal()">Покинуть игру как создатель</button>
        <br/>
        <br/>
        <button class="button" onclick="askBeforeLeave()">Покинуть игру с подтверждением</button>
        <br/>
        <br/>
        <button class="button" onclick="leaveCurrentGame()">Покинуть игру</button>
        <br/>
        <br/>
        <a class="button" href="/online">Вернуться к списку</a>
    </section>
</div>

<!--// modal windows for second player-->
<div id="sessionClosedModal" class="modal" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5);">
    <div style="width:300px; margin:100px auto; background:#fff; padding:20px;">
        <h3>Игровая сессия была закрыта!</h3>
        <p>Возврат к списку через <span id="closeTimer">5</span> c...</p>
        <button class="button" onclick="goToList()">К списку игр</button>
    </div>
</div>

<!-- Модалка для подтверждения выхода создателем -->
<div id="creatorLeaveModal" class="modal" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5);">
    <div style="width:300px; margin:100px auto; background:#fff; padding:20px;">
        <h3>Выход из игры</h3>
        <p>Вы уверены, что хотите покинуть игру?</p>
        <button class="button is-danger" onclick="confirmCreatorLeave()">Выйти</button>
        <button class="button" onclick="cancelCreatorLeave()">Отменить</button>
    </div>
</div>

</body>
</html>