<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Online Game (WebSocket)</title>
    <meta charset="UTF-8"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let gameId = 0;
        let currentNick = "";

        function connect() {
            // Create SockJS connection
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                // Subscribe to this game's topic
                stompClient.subscribe('/topic/online-game-' + gameId, function(message) {
                    const onlineGame = JSON.parse(message.body);
                    updateBoard(onlineGame.game);
                    updateStatus(onlineGame);
                });
            });
        }

        function sendMove(r, c) {
            const msg = {
                gameId: gameId,
                nick: currentNick,
                row: r,
                col: c
            };
            stompClient.send("/app/online-move", {}, JSON.stringify(msg));
        }

        function updateBoard(game) {
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cellId = 'cell' + i + j;
                    const cell = document.getElementById(cellId);
                    cell.innerText = game.board[i][j] ? game.board[i][j] : '';
                }
            }
        }

        function updateStatus(onlineGame) {
            const g = onlineGame.game;
            const statusEl = document.getElementById('status');
            if (g.gameOver) {
                if (g.winner === 'DRAW') {
                    statusEl.innerText = 'Ничья!';
                } else {
                    statusEl.innerText = 'Победитель: ' + g.winner;
                }
            } else {
                statusEl.innerText = 'Ход: ' + g.currentPlayer;
            }
            // Update playerX / playerO on screen
            document.getElementById('playerX').innerText = onlineGame.playerX;
            document.getElementById('playerO').innerText = onlineGame.playerO ? onlineGame.playerO : '---';
        }

        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            gameId = urlParams.get('gameId');
            document.getElementById('gid').innerText = gameId;

            currentNick = document.getElementById('nick').innerText;
            connect();
        });
    </script>
</head>
<body>
<div class="container">
    <section class="section">
        <h1 class="title">Онлайн-игра (WebSocket). Партия #<span id="gid"></span></h1>
        <p>Ваш ник: <span id="nick" th:text="${nick}">Guest</span></p>
        <p>Игрок X: <span id="playerX" th:text="${onlineGame.playerX}">?</span></p>
        <p>Игрок O: <span id="playerO" th:text="${onlineGame.playerO}">?</span></p>
        <p id="status" style="font-weight: bold; margin-top:10px;">Ожидание данных...</p>

        <!-- 3x3 field -->
        <div style="margin-top:20px;">
            <div style="display:flex;">
                <div id="cell00" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(0,0)"></div>
                <div id="cell01" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(0,1)"></div>
                <div id="cell02" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(0,2)"></div>
            </div>
            <div style="display:flex;">
                <div id="cell10" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(1,0)"></div>
                <div id="cell11" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(1,1)"></div>
                <div id="cell12" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(1,2)"></div>
            </div>
            <div style="display:flex;">
                <div id="cell20" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(2,0)"></div>
                <div id="cell21" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(2,1)"></div>
                <div id="cell22" class="box" style="width:60px;height:60px;margin:2px;text-align:center;cursor:pointer;font-size:24px;"
                     onclick="sendMove(2,2)"></div>
            </div>
        </div>
        <br/>
        <a class="button" href="/online">Вернуться к списку</a>
    </section>
</div>
</body>
</html>
