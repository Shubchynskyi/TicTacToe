<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Сетевые игры</title>
    <meta charset="UTF-8"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompList = null;

        function connectList() {
            console.log("connectList called");
            const sock = new SockJS('/ws');
            stompList = Stomp.over(sock);
            stompList.connect({}, frame => {
                console.log("Connected for /topic/game-list, frame=" + frame);


                stompList.subscribe("/topic/game-list", msg => {
                    const games = JSON.parse(msg.body);
                    console.log("Got updated list via WS => partial render");
                    if (window.location.pathname === "/online") {
                        renderGameList(games);
                    } else {
                        console.log("We are not on /online => skip partial update");
                    }
                });
            });
        }

        // Частичный рендер таблицы
        function renderGameList(games) {
            console.log("renderGameList called with ", games);

            const tbody = document.getElementById('gamesBody');
            let html = '';

            // Получаем мой ник
            const myNickSpan = document.getElementById('myNickSpan');
            const myNick = myNickSpan ? myNickSpan.innerText : "";

            games.forEach(g => {
                // Определяем текст статуса (если хотите что-то особенное)
                const status = g.waitingForSecondPlayer
                    ? 'Ожидает второго'
                    : 'Игра идёт';

                // Логика "жирный" ник для creatorNick+playerX / playerO
                let pxClass = ((myNick === g.creatorNick) && (g.playerX === myNick))
                    ? "has-text-weight-bold" : "";
                let poClass = ((myNick === g.creatorNick) && (g.playerO === myNick))
                    ? "has-text-weight-bold" : "";

                // ====> ВАЖНО: Генерируем колонку "Действие" (кнопка) <====
                let actionHtml = '';
                if (g.waitingForSecondPlayer) {
                    // Игра ещё ждёт второго => кнопка "Присоединиться"
                    actionHtml = `
                <a class="button is-small is-info"
                   href="/join-online?gameId=${g.gameId}">
                    Присоединиться
                </a>
            `;
                } else {
                    // Уже 2 игрока
                    if (myNick === g.playerX || myNick === g.playerO) {
                        // Я один из игроков => "Перейти"
                        actionHtml = `
                    <a class="button is-small is-link"
                       href="/onlineGame?gameId=${g.gameId}">
                        Перейти
                    </a>
                `;
                    } else {
                        // Третий (не X, не O) => просто надпись "Идёт игра"
                        actionHtml = `
                    <span>Идёт игра</span>
                `;
                    }
                }

                // ====> Формируем одну строку <tr> полностью <====
                html += `
            <tr>
              <td>${g.gameId}</td>
              <td class="${pxClass}">${g.playerX ?? ''}</td>
              <td class="${poClass}">${g.playerO ?? ''}</td>
              <td>${status}</td>
              <td>${actionHtml}</td>
            </tr>
        `;
            });

            // Записываем новое содержимое таблицы
            tbody.innerHTML = html;
        }

        function doRefresh() {
            window.location.reload();
        }

        // Подключаемся при загрузке
        window.addEventListener('load', () => {
            connectList();
        });
    </script>
</head>
<body>
<div class="container">
    <section class="section">
        <h1 class="title">Сетевые игры</h1>
        <!-- мой ник -->
        <p>Ваш ник: <span id="myNickSpan" th:text="${nick}">?</span></p>

        <form action="/create-online" method="post">
            <button class="button is-primary" type="submit">Создать новую игру</button>
        </form>

        <button class="button" onclick="doRefresh()">Обновить</button>
        <hr/>

        <table class="table is-fullwidth">
            <thead>
            <tr>
                <th>ID</th>
                <th>Player X</th>
                <th>Player O</th>
                <th>Статус</th>
                <th>Действие</th>
            </tr>
            </thead>
            <tbody id="gamesBody">
            <tr th:each="g : ${games}">
                <td th:text="${g.gameId}">?</td>

                <td th:text="${g.playerX}"
                    th:classappend="${(nick == g.creatorNick && nick == g.playerX)}
                                     ? 'has-text-weight-bold':''">
                </td>
                <td th:text="${g.playerO}"
                    th:classappend="${(nick == g.creatorNick && nick == g.playerO)}
                                     ? 'has-text-weight-bold':''">
                </td>

                <td>
                    <span th:if="${g.waitingForSecondPlayer}">
                        Ожидает второго
                    </span>
                    <span th:if="${!g.waitingForSecondPlayer}">
                        Игра идёт
                    </span>
                </td>

                <td>
                    <!-- If waiting => Join link -->
                    <a class="button is-small is-info"
                       th:href="@{/join-online(gameId=${g.gameId})}"
                       th:if="${g.waitingForSecondPlayer}">
                        Присоединиться
                    </a>

                    <!-- If 2 players => check if I'm X/O => "Перейти" else "Идёт игра" -->
                    <span th:if="${(!g.waitingForSecondPlayer)
                                   && (nick != g.playerX && nick != g.playerO)}">Идёт игра</span>

                    <a class="button is-small is-link"
                       th:href="@{/onlineGame(gameId=${g.gameId})}"
                       th:if="${(!g.waitingForSecondPlayer)
                                && (nick == g.playerX || nick == g.playerO)}">
                        Перейти
                    </a>
                </td>
            </tr>
            </tbody>
        </table>

        <br/>
        <a class="button" href="/">Назад</a>
    </section>
</div>
</body>
</html>