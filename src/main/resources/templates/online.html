<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Online Games</title>
    <meta charset="UTF-8"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- ADD script for SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompList = null;
        // function connectList() {
        //     const socket = new SockJS('/ws');
        //     stompList = Stomp.over(socket);
        //     stompList.connect({}, function(frame){
        //         console.log('Connected to /ws for game-list: ' + frame);
        //         stompList.subscribe('/topic/game-list', function(msg){
        //             const updatedGames = JSON.parse(msg.body);
        //             renderGameList(updatedGames);
        //         });
        //     });
        // }

        function connectList() {
            const sock = new SockJS('/ws');
            const stompList = Stomp.over(sock);
            stompList.connect({}, frame => {
                console.log("Connected for /topic/game-list");
                stompList.subscribe("/topic/game-list", msg => {
                    const games = JSON.parse(msg.body);
                    renderGameList(games);
                });
            });
        }

        window.addEventListener('load', ()=> {
            connectList();
            // + fetch('/online-list') ... etc.
        });

        function renderGameList(games) {
            // У вас уже есть <tbody> со списком,
            // мы можем перерисовать таблицу через innerHTML
            const tbody = document.getElementById('gamesBody');
            let html = '';
            games.forEach(g => {
                const status = g.waitingForSecondPlayer ? 'Ожидает второго' : 'Игра идёт';
                html += `
          <tr>
            <td>${g.gameId}</td>
            <td>${g.playerX ?? ''}</td>
            <td>${g.playerO ?? ''}</td>
            <td>${status}</td>
            <td>
              ${
                    g.waitingForSecondPlayer
                        ? `<a class="button is-small is-info" href="/join-online?gameId=${g.gameId}">Присоединиться</a>`
                        : `<a class="button is-small is-link" href="/onlineGame?gameId=${g.gameId}">Перейти</a>`
                }
            </td>
          </tr>
        `;
            });
            tbody.innerHTML = html;
        }

        window.addEventListener('load', connectList);

        function forceRefresh() {
            // либо просто перезагрузим страницу:
            // location.reload();

            // location.reload();
            fetch('/online-list')
                .then(r=>r.json())
                .then(games => renderGameList(games))
                .catch(e=> console.error(e));

            // или fetch('/online-list') и renderGameList(...)
            // fetch('/online-list')
            //     .then(r=>r.json())
            //     .then(games => {
            //         renderGameList(games);
            //     })
            //     .catch(e=>console.error(e));
        }
    </script>
</head>
<body>
<div class="container">
    <section class="section">
        <h1 class="title">Сетевые игры</h1>
        <p>Ваш ник: <span th:text="${nick}">?</span></p>

        <form action="/create-online" method="post">
            <button class="button is-primary">Создать новую игру</button>
        </form>
        <button class="button" onclick="forceRefresh()">Обновить</button> <!-- <--- ADD -->
        <hr/>
        <table class="table is-fullwidth">
            <thead>
            <tr>
                <th>ID</th>
                <th>Player X</th>
                <th>Player O</th>
                <th>Статус</th>
                <th>Действие</th>
            </tr>
            </thead>
            <tbody id="gamesBody">
            <!-- Здесь Thymeleaf сотрёт при генерации,
                 но мы можем оставить th:each для начального списка
                 ИЛИ вообще убираем th:each, рендерим целиком JS -->
            <tr th:each="g : ${games}">
                <td th:text="${g.gameId}">?</td>

                <td th:if="${nick == g.creatorNick}" style="font-weight:bold;" th:text="${g.playerX}">X</td>
                <td th:if="${nick != g.creatorNick}" th:text="${g.playerX}">X</td>

                <td th:if="${nick == g.creatorNick}" style="font-weight:bold;" th:text="${g.playerO}">X</td>
                <td th:if="${nick != g.creatorNick}" th:text="${g.playerO}">O</td>

<!--                <td th:text="${g.playerX}">?</td>-->
<!--                <td th:text="${g.playerO}">?</td>-->
                <td>
                    <span th:if="${g.waitingForSecondPlayer}">Ожидает второго</span>
                    <span th:if="${!g.waitingForSecondPlayer}">Игра идёт</span>
                </td>
<!--                <td>-->
<!--                    <a class="button is-small is-info"-->
<!--                       th:href="@{/join-online(gameId=${g.gameId})}"-->
<!--                       th:if="${g.waitingForSecondPlayer}">-->
<!--                        Присоединиться-->
<!--                    </a>-->
<!--                    <span th:if="${!g.waitingForSecondPlayer}">Идёт игра</span>-->
<!--                </td>-->
                <td>
                    <a class="button is-small is-info"
                       th:href="@{/join-online(gameId=${g.gameId})}"
                       th:if="${g.waitingForSecondPlayer}">
                        Присоединиться
                    </a>
                    <a class="button is-small is-link"
                       th:href="@{/onlineGame(gameId=${g.gameId})}"
                       th:if="${!g.waitingForSecondPlayer}">
                        Идёт игра
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
        <br/>
        <a class="button" href="/">Назад</a>
    </section>
</div>
</body>
</html>
